---
title: "ERGM_team"
author: "Timo Timmermans"
date: "2024-11-13"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load data}
library(igraph)
```


```{r load data}
valid_edges <- read.csv("Valid_edges.csv")
data_combined <- read.csv("vertice_data.csv")

state_dependency_matrix <- readr::read_csv("state_dependency_matrix.csv")
state_dependency_matrix <- as.matrix(state_dependency_matrix)
rownames(state_dependency_matrix) <- colnames(state_dependency_matrix)
```



```{r pressure, echo=FALSE}
rivalry_edges <- subset(valid_edges, type == "rivalry")
g <- igraph::graph_from_data_frame(d = rivalry_edges, vertices = data_combined, directed = FALSE)

# Identify and remove isolates (nodes with degree zero)
isolates <- igraph::V(g)[igraph::degree(g) == 0]  # Find nodes with no connections
g <- igraph::delete_vertices(g, isolates)  # Remove isolates

# Change to network
g <- snafun::to_network(g)

# Filter only alliance relationships
alliance_edges <- subset(valid_edges, type == "alliance")
g_alliances <- graph_from_data_frame(d = alliance_edges, vertices = data_combined, directed = FALSE)
g_alliances <- snafun::to_network(g_alliances)
```

```{r}
g_alliances_matrix <- as.matrix(g_alliances)
(dim(g_alliances_matrix))  # Ensure this matches the dimension of g
(any(is.na(g_alliances_matrix)))

g_rivalry_matrix <- as.matrix(g)
(dim(g_rivalry_matrix))  # Ensure this matches the dimension of g
(any(is.na(g_rivalry_matrix)))

# Step 1: Identify the common rows and columns
common_rows <- intersect(rownames(g_alliances_matrix), rownames(g_rivalry_matrix))
common_cols <- intersect(colnames(g_alliances_matrix), colnames(g_rivalry_matrix))

# Step 2: Subset both matrices to keep only the common rows and columns
g_alliances_matrix <- g_alliances_matrix[common_rows, common_cols, drop = FALSE]
(dim(g_alliances_matrix))  # Ensure this matches the dimension of g
(any(is.na(g_alliances_matrix)))

state_dependency_matrix <- as.matrix(state_dependency_matrix)

common_rows <- intersect(rownames(state_dependency_matrix), rownames(g_rivalry_matrix))
common_cols <- intersect(colnames(state_dependency_matrix), colnames(g_rivalry_matrix))

state_dependency_matrix1 <- state_dependency_matrix[common_rows, common_cols, drop = FALSE]
(dim(state_dependency_matrix1))  # Ensure this matches the dimension of g
(any(is.na(state_dependency_matrix1)))
```

```{r}
# Check node names in alliance network
alliance_node_names <- network::get.vertex.attribute(g_alliances, "vertex.names")
print(alliance_node_names)

# Check node names in rivalry network
rivalry_node_names <- network::get.vertex.attribute(g, "vertex.names")
print(rivalry_node_names)

# Standardize node names to lowercase and trim any whitespace
alliance_node_names <- tolower(trimws(alliance_node_names))
rivalry_node_names <- tolower(trimws(rivalry_node_names))

# Calculate degrees in alliance network
alliance_degrees <- sna::degree(alliance_net)

# Match alliance degrees to node names in rivalry network
alliance_degrees_matched <- alliance_degrees[match(rivalry_node_names, alliance_node_names)]

# Replace any NAs with 0 to ensure complete data
alliance_degrees_matched[is.na(alliance_degrees_matched)] <- 0

# Assign the matched alliance degree to rivalry network
network::set.vertex.attribute(g, "alliance_degree", alliance_degrees_matched)
```

```{r}
# Check node names in alliance network
alliance_node_names <- network::get.vertex.attribute(g_alliances, "vertex.names")
print(alliance_node_names)

# Check node names in rivalry network
rivalry_node_names <- network::get.vertex.attribute(g, "vertex.names")
print(rivalry_node_names)

# Standardize node names to lowercase and trim any whitespace
alliance_node_names <- tolower(trimws(alliance_node_names))
rivalry_node_names <- tolower(trimws(rivalry_node_names))

# Convert alliance network to igraph to calculate eigenvector centrality
library(intergraph)
alliance_igraph <- asIgraph(g_alliances)

# Calculate eigenvector centrality in the alliance network
alliance_eigenvector <- igraph::eigen_centrality(alliance_igraph)$vector

# Match alliance eigenvector centrality to node names in rivalry network
alliance_eigenvector_matched <- alliance_eigenvector[match(rivalry_node_names, alliance_node_names)]

# Replace any NAs with 0 to ensure complete data
alliance_eigenvector_matched[is.na(alliance_eigenvector_matched)] <- 0

# Assign the matched alliance eigenvector centrality to the rivalry network
network::set.vertex.attribute(g, "alliance_eigenvector", alliance_eigenvector_matched)
```

```{r}
# Retrieve the alliance_degree attribute
alliance_degree <- network::get.vertex.attribute(g, "alliance_degree")
# Find indices of nodes with NA in alliance_degree
na_indices <- which(is.na(alliance_degree))

# Print the names or indices of nodes with NA values
node_names_with_na <- get.vertex.attribute(rivalry_graph, "vertex.names")[na_indices]
node_names_with_na

```

```{r}
rivalryattr <- network::get.vertex.attribute(g, 'estado')

state_counts <- sapply(rivalryattr, function(x) {
  length(unlist(strsplit(x, ";")))
})

network::set.vertex.attribute(g, "num_states", state_counts)
network::get.vertex.attribute(g, "num_states")
```

```{r}
m0 <- ergm::ergm(g ~ edges)
summary(m0)

```

```{r, fig.width=8, fig.height=6}
m1 <- ergm::ergm((g ~ edges + gwesp(0.5, fixed = TRUE) + edgecov(state_dependency_matrix1) + nodecov("alliance_degree")), control = ergm::control.ergm(MCMC.burnin = 5000,
                                               MCMC.samplesize = 10000,
                                               seed = 123456,
                                               MCMLE.maxit = 20))
summary(m1)
ergm::mcmc.diagnostics(m1)

gofm <- ergm::gof(m1)
snafun::stat_plot_gof(gofm)

```

```{r, fig.width=8, fig.height=6}
m2 <- ergm::ergm(
  g ~ edges + 
    gwesp(0.5, fixed = TRUE) + 
    degree(1) + 
    gwdsp(0.5, fixed = TRUE) + 
    nodecov("alliance_eigenvector") + 
    nodecov("alliance_degree") +
    edgecov(state_dependency_matrix1),
  control = ergm::control.ergm(
    MCMC.burnin = 5000,
    MCMC.samplesize = 10000,
    seed = 123456,
    MCMLE.maxit = 20
  )
)
summary(m2)
ergm::mcmc.diagnostics(m2)

gofm <- ergm::gof(m2)
snafun::stat_plot_gof(gofm)

```

```{r}
#only necessary terms to answer research questions
m3 <- ergm::ergm(
  g ~ edges + 
    gwesp(0.5, fixed = TRUE) + 
    nodecov("alliance_eigenvector") + 
    edgecov(state_dependency_matrix1) +
    kstar(2), 
  control = ergm::control.ergm(
    MCMC.burnin = 5000,
    MCMC.samplesize = 10000,
    seed = 123456,
    MCMLE.maxit = 20,
    parallel=4
  )
)
summary(m3)
ergm::mcmc.diagnostics(m3)

gofm <- ergm::gof(m3)
snafun::stat_plot_gof(gofm)
```


```{r, fig.width=8, fig.height=6} 
#only necessary terms to answer research questions
m4 <- ergm::ergm(
  g ~ edges + 
    gwesp(0.5, fixed = TRUE) + 
    nodecov("alliance_eigenvector") + 
    edgecov(state_dependency_matrix1) +
    kstar(2) +
    nodecov("num_states"), 
  control = ergm::control.ergm(
    MCMC.burnin = 5000,
    MCMC.samplesize = 10000,
    seed = 123456,
    MCMLE.maxit = 20,
    parallel=4
  )
)
summary(m4)
ergm::mcmc.diagnostics(m4)

gofm <- ergm::gof(m4)
snafun::stat_plot_gof(gofm)

```

```{r, fig.width=8, fig.height=6} 
m5 <- ergm::ergm(
  g ~ edges + 
    gwesp(0.5, fixed = TRUE) + 
    nodecov("alliance_eigenvector") + 
    edgecov(state_dependency_matrix1) +
    kstar(2) + 
    nodecov("num_states") +
    degree(1),
  control = ergm::control.ergm(
    MCMC.burnin = 5000,
    MCMC.samplesize = 10000,
    seed = 123456,
    MCMLE.maxit = 20,
    parallel=4
  )
)
summary(m5)
ergm::mcmc.diagnostics(m5)

gofm <- ergm::gof(m5)
snafun::stat_plot_gof(gofm)

```

```{r, fig.width=8, fig.height=6} 
m6 <- ergm::ergm(
  g ~ edges + 
    gwesp(0.5, fixed = TRUE) + 
    nodecov("alliance_eigenvector") + 
    edgecov(state_dependency_matrix1) +
    kstar(2) +
    degree(1) +
    nodecov("num_states") +
    gwdsp(0.5, fixed = TRUE),
  control = ergm::control.ergm(
    MCMC.burnin = 5000,
    MCMC.samplesize = 10000,
    seed = 123456,
    MCMLE.maxit = 20,
    parallel=5
  )
)
summary(m6)
ergm::mcmc.diagnostics(m6)

gofm <- ergm::gof(m5)
snafun::stat_plot_gof(gofm)

```



