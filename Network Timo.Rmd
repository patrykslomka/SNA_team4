---
title: "Data preperation notebook"
output: html_notebook
---


```{r, load libraries}
# Load libraries
library(readxl)
library(igraph)
library(dplyr)
library(stringr)

# Load the data
data <- read_excel("C:/Users/timot/Documents/Master data science for business and entrepreneurship/Social network analysis/BACRIM2020-DB.xlsx")

# Combine rows with the same 'grupo' by concatenating alliances and setting binary columns
data_combined <- data %>%
  group_by(grupo) %>%  # Group by grupo only
  summarise(
    aliados = paste(na.omit(unique(unlist(strsplit(aliados, ";")))), collapse = ";"),  # Concatenate unique allies
    rivales = paste(na.omit(unique(unlist(strsplit(rivales, ";")))), collapse = ";"),  # Concatenate unique rivals
    persona = paste(na.omit(persona), collapse = ";"),  # Concatenate persona information if it exists
    `número de rivales` = ifelse(any(`número de rivales` == 1, na.rm = TRUE), 1, 0),
    actividades_delictivas = ifelse(any(actividades_delictivas == 1, na.rm = TRUE), 1, 0),
    narcotrafico = ifelse(any(narcotrafico == 1, na.rm = TRUE), 1, 0),
    conflictos_armados = ifelse(any(conflictos_armados == 1, na.rm = TRUE), 1, 0),
    presencia_noviolenta = ifelse(any(presencia_noviolenta == 1, na.rm = TRUE), 1, 0),
    accion_guber = ifelse(any(accion_guber == 1, na.rm = TRUE), 1, 0),
    otros = ifelse(any(otros == 1, na.rm = TRUE), 1, 0)
  ) %>%
  ungroup()

# Prepare edges (alliances and rivalries) with unique `grupo` identifiers
edges <- data.frame()
for (i in 1:nrow(data_combined)) {
  cartel <- data_combined$grupo[i]  # Use only the grupo name
  
  # Process allies
  if (!is.na(data_combined$aliados[i])) {
    allies <- strsplit(data_combined$aliados[i], ";")[[1]]
    for (ally in allies) {
      edges <- rbind(edges, data.frame(from = cartel, to = ally, type = "alliance"))
    }
  }
  
  # Process rivals
  if (!is.na(data_combined$rivales[i])) {
    rivals <- strsplit(data_combined$rivales[i], ";")[[1]]
    for (rival in rivals) {
      edges <- rbind(edges, data.frame(from = cartel, to = rival, type = "rivalry"))
    }
  }
}

# Remove duplicate edges
edges <- unique(edges)

# Remove duplicate edges by treating pairs of nodes as undirected
# Sort the 'from' and 'to' columns for each row, so (A, B) and (B, A) are treated as the same
edges <- edges %>%
  rowwise() %>%
  mutate(
    from_sorted = min(from, to),  # Get the "smaller" name lexicographically
    to_sorted = max(from, to)     # Get the "larger" name lexicographically
  ) %>%
  ungroup() %>%
  distinct(from_sorted, to_sorted, .keep_all = TRUE) %>%  # Keep only one direction
  select(from, to, type)  # Restore original column names for graph creation

# Now `valid_edges` contains only one undirected edge between any pair of nodes
# Filter edges to keep only those where both 'from' and 'to' vertices exist in data_combined
valid_edges <- edges %>%
  semi_join(data_combined, by = c("from" = "grupo")) %>%
  semi_join(data_combined, by = c("to" = "grupo"))

# Create graph with unique `grupo` as vertices
g <- graph_from_data_frame(d = valid_edges, vertices = data_combined, directed = FALSE)
```

```{r Simple plot of the network}
# Plot the network without labels and with smaller vertices
plot(g, vertex.label = NA, vertex.size = 5, 
     edge.color = ifelse(E(g)$type == "alliance", "blue", "red"),
     main = "Cartel Network (Alliances and Rivalries)")
```



```{r, Interactive plot of the network}
library(visNetwork)

# Convert the igraph object to a data frame for visNetwork
nodes <- data.frame(id = V(g)$name)
edges <- data.frame(
  from = as.character(get.edgelist(g)[,1]),
  to = as.character(get.edgelist(g)[,2]),
  color = ifelse(E(g)$type == "alliance", "blue", "red")  # Set color by type
)

# Create the interactive network visualization with custom edge colors
visNetwork(nodes, edges) %>%
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
  visEdges(color = list(color = edges$color)) %>%
  visLayout(randomSeed = 123)
```


```{r Complex figure without unconnected nodes as presented by Shaghi}
# Create a subgraph with only alliance edges
alliance_graph <- subgraph.edges(g, E(g)[E(g)$type == "rivalry"])

# Remove unconnected nodes from the alliance-only subgraph
g_no_uncconnected_nodes <- delete.vertices(alliance_graph, which(degree(alliance_graph) == 0))

# Apply community detection using the Louvain method
communities <- cluster_louvain(g_no_uncconnected_nodes)

# Assign each node a unique color based on its community membership
community_colors <- rainbow(length(unique(membership(communities))))
V(g_no_uncconnected_nodes)$color <- community_colors[membership(communities)]

# Adjust node sizes based on degree
V(g_no_uncconnected_nodes)$size <- igraph::degree(g_no_uncconnected_nodes, mode = "all") * 0.5 + 5

# Set edge colors with transparency
E(g_no_uncconnected_nodes)$color <- ifelse(E(g_no_uncconnected_nodes)$type == "alliance", adjustcolor("blue", alpha.f = 0.5), adjustcolor("red", alpha.f = 0.5))
E(g_no_uncconnected_nodes)$curved <- 0.1  # Reduce edge curvature

# Set background color
par(bg = "lightgray")
V(g_no_uncconnected_nodes)$label.color <- "black"  # Set label color to black for visibility

# Plot the network with improved visualization
plot(
  g_no_uncconnected_nodes,
  vertex.label = ifelse(igraph::degree(g_no_uncconnected_nodes) > 10, V(g_no_uncconnected_nodes)$name, NA),           # Display labels for nodes with high degree
  vertex.label.cex = 0.8,                          # Increase label size
  vertex.label.dist = 0.5,                         # Adjust label offset to keep labels close to nodes
  vertex.size = V(g_no_uncconnected_nodes)$size,                         # Set node size by degree
  layout = layout_with_fr(g_no_uncconnected_nodes, niter = 10000, area = 30 * vcount(g_no_uncconnected_nodes)^2),  # Fruchterman-Reingold layout
  main = "Improved Cartel Network with Alliances and Rivalries"
)

# Add a legend for community colors
legend(
  "topright",
  legend = paste("Community", 1:length(unique(membership(communities)))),
  col = community_colors,
  pch = 19,           # Use filled circles in legend
  title = "Cartel Communities",
  cex = 0.8           # Adjust legend size for readability
)

# Add a legend for edge colors
legend(
  "bottomright",
  legend = c("Alliance", "Rivalry"),
  col = c("blue", "red"),
  lwd = 2,             # Line width for edge type in legend
  title = "Relationship Type",
  cex = 0.8            # Adjust legend size for readability
)

```
